<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mason's MedWay</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #0A0A0A;
      --surface: #111111;
      --surface-hover: #1A1A1A;
      --border: #1F1F1F;
      --text-primary: #F5F5F0;
      --text-secondary: #8A8A82;
      --text-muted: #4A4A45;
      --accent: #C8D96F;
      --danger: #E85D5D;
      --amber: #D4A54A;
      --success: #5DAE72;
      --route-glow: #C8D96F33;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text-secondary);
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* --- NAV --- */
    nav {
      position: fixed; top: 0; left: 0; width: 100%; padding: 16px 20px;
      z-index: 1000; display: flex; justify-content: space-between; align-items: center;
      background: rgba(10,10,10,0.85); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      transition: background 0.3s, border-color 0.3s;
    }
    nav.scrolled {
      background: rgba(10,10,10,0.95);
    }
    .nav-logo { color: var(--text-primary); text-transform: uppercase; letter-spacing: 3px; font-size: 12px; font-weight: 600; }
    .nav-route { display: none; font-size: 12px; color: var(--text-muted); text-align: center; flex: 1; margin: 0 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .nav-right { display: flex; align-items: center; gap: 10px; }
    .gps-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--danger); transition: background 0.3s, box-shadow 0.3s; }
    .gps-dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); animation: gpsPulse 2s infinite; }
    @keyframes gpsPulse { 0%,100% { box-shadow: 0 0 8px var(--success); } 50% { box-shadow: 0 0 16px var(--success); } }
    .btn-change-route {
      font-size: 11px; padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border);
      background: transparent; color: var(--text-muted); cursor: pointer; transition: all 0.2s; display: none;
    }
    .btn-change-route:hover { border-color: var(--text-muted); color: var(--text-secondary); }

    /* --- ROUTE ENTRY SCREEN --- */
    #entry-screen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 100vh; padding: 24px; text-align: center;
    }
    .entry-logo { font-size: 12px; text-transform: uppercase; letter-spacing: 3px; color: var(--text-muted); font-weight: 600; margin-bottom: 48px; }
    .entry-title { font-size: clamp(36px, 8vw, 64px); color: var(--text-primary); font-weight: 700; letter-spacing: -1.5px; line-height: 1.05; margin-bottom: 12px; }
    .entry-sub { font-size: 16px; color: var(--text-secondary); margin-bottom: 48px; max-width: 400px; line-height: 1.6; }
    .entry-form { width: 100%; max-width: 440px; display: flex; flex-direction: column; gap: 16px; }
    .input-group { position: relative; }
    .input-group label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; margin-bottom: 8px; text-align: left; }
    .input-group input {
      width: 100%; padding: 16px 18px; background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; color: var(--text-primary); font-size: 16px; font-family: inherit;
      outline: none; transition: border-color 0.2s;
    }
    .input-group input::placeholder { color: var(--text-muted); }
    .input-group input:focus { border-color: var(--accent); }
    .btn-locate {
      position: absolute; right: 12px; bottom: 12px; background: var(--surface-hover); border: 1px solid var(--border);
      color: var(--text-secondary); font-size: 12px; padding: 8px 12px; border-radius: 8px; cursor: pointer;
      font-family: inherit; transition: all 0.2s;
    }
    .btn-locate:hover { border-color: var(--accent); color: var(--accent); }
    .btn-find {
      width: 100%; padding: 18px; background: var(--accent); color: var(--bg); font-size: 16px;
      font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-family: inherit;
      transition: all 0.2s; margin-top: 8px;
    }
    .btn-find:hover { filter: brightness(1.1); transform: translateY(-2px); }
    .btn-find:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .entry-error { color: var(--danger); font-size: 13px; margin-top: 8px; display: none; }

    /* --- LOADING OVERLAY --- */
    #loading-overlay {
      display: none; position: fixed; inset: 0; z-index: 2000; background: var(--bg);
      flex-direction: column; align-items: center; justify-content: center; gap: 24px;
    }
    .loading-text { font-size: 16px; color: var(--text-secondary); }
    .loading-bar { width: 200px; height: 2px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .loading-bar-fill { width: 0%; height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; }
    .loading-sub { font-size: 13px; color: var(--text-muted); }

    /* --- ROUTE SELECTION --- */
    #route-select { display: none; position: fixed; inset: 0; z-index: 1500; background: var(--bg); }
    #route-select-map { width: 100%; height: 60%; }
    .route-select-panel {
      position: absolute; bottom: 0; left: 0; right: 0; height: 40%;
      background: var(--bg); border-top: 1px solid var(--border);
      padding: 20px; overflow-y: auto;
    }
    .route-select-label {
      font-size: 11px; text-transform: uppercase; letter-spacing: 2px;
      color: var(--text-muted); font-weight: 600; margin-bottom: 16px;
    }
    .route-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
    .route-option {
      display: flex; align-items: center; gap: 14px; padding: 16px;
      background: var(--surface); border: 2px solid var(--border); border-radius: 12px;
      cursor: pointer; transition: all 0.2s; font-family: inherit;
      color: var(--text-secondary); text-align: left; width: 100%;
    }
    .route-option:hover { background: var(--surface-hover); }
    .route-option.selected { border-color: var(--accent); background: rgba(200,217,111,0.06); }
    .route-option .ro-index {
      width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700; flex-shrink: 0;
      background: var(--border); color: var(--text-muted); transition: all 0.2s;
    }
    .route-option.selected .ro-index { background: var(--accent); color: var(--bg); }
    .route-option .ro-details { flex: 1; }
    .route-option .ro-duration { font-size: 16px; color: var(--text-primary); font-weight: 600; }
    .route-option .ro-meta { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
    .route-option .ro-via { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .btn-use-route {
      width: 100%; padding: 16px; background: var(--accent); color: var(--bg); font-size: 15px;
      font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-family: inherit;
      transition: all 0.2s;
    }
    .btn-use-route:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .route-select-back {
      position: absolute; top: 16px; left: 16px; z-index: 10;
      background: rgba(10,10,10,0.8); backdrop-filter: blur(8px); border: 1px solid var(--border);
      color: var(--text-primary); padding: 8px 14px; border-radius: 8px; font-size: 13px;
      cursor: pointer; font-family: inherit; transition: all 0.2s;
    }
    .route-select-back:hover { background: var(--surface-hover); }

    /* --- TRACKING VIEW --- */
    #tracking-view { display: none; }

    /* Map */
    #hero { height: 50vh; width: 100%; position: relative; }
    #map { width: 100%; height: 100%; background: var(--bg); z-index: 1; }
    .hero-overlay {
      position: absolute; bottom: 24px; left: 20px; z-index: 500; pointer-events: none;
      background: rgba(10,10,10,0.75); backdrop-filter: blur(8px);
      padding: 16px 20px; border-radius: 10px; border: 1px solid var(--border);
    }
    .hero-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); font-weight: 600; margin-bottom: 6px; }
    .hero-title { font-size: clamp(24px, 6vw, 40px); font-weight: 700; color: var(--text-primary); letter-spacing: -1px; line-height: 1; margin-bottom: 6px; }
    .hero-sub { font-size: 13px; color: var(--text-primary); font-weight: 400; opacity: 0.7; }
    .scroll-indicator {
      position: absolute; bottom: 24px; right: 20px; z-index: 500;
      width: 1px; height: 36px; background: var(--border); overflow: hidden;
    }
    .scroll-indicator::after {
      content: ''; display: block; width: 100%; height: 50%;
      background: var(--text-primary); animation: scrollDown 2s infinite ease-in-out;
    }
    @keyframes scrollDown { 0% { transform: translateY(-100%); } 100% { transform: translateY(200%); } }

    /* Sections */
    section { padding: 80px 20px; max-width: 680px; margin: 0 auto; }
    .sec-num { font-family: monospace; color: var(--text-muted); font-size: 13px; margin-bottom: 20px; display: block; letter-spacing: 1px; font-weight: 500; }
    h2 { font-size: clamp(28px, 7vw, 44px); color: var(--text-primary); margin: 0 0 12px; font-weight: 600; letter-spacing: -0.5px; line-height: 1.1; }
    p.sec-desc { font-size: 15px; line-height: 1.6; color: var(--text-secondary); margin-bottom: 40px; max-width: 480px; }

    /* Dashboard */
    .dash-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .dash-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .dash-card.wide { grid-column: 1 / -1; }
    .dash-card label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; }
    .dash-card .val { font-size: 20px; color: var(--text-primary); font-weight: 500; letter-spacing: -0.3px; }
    .dash-card .val.amber { color: var(--amber); }
    #gps-banner { display: none; background: var(--border); color: var(--text-primary); padding: 20px; border-radius: 12px; font-weight: 500; line-height: 1.5; font-size: 14px; margin-bottom: 16px; }

    /* Hospital Cards */
    .hospital-list { display: flex; flex-direction: column; gap: 20px; }
    .h-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      padding: 24px; transition: transform 0.3s, background 0.3s; border-left: 3px solid var(--success);
    }
    .h-card:hover { background: var(--surface-hover); }
    .h-card.passed { border-left-color: var(--amber); opacity: 0.85; }
    .h-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 12px; }
    .h-title { font-size: 18px; color: var(--text-primary); font-weight: 600; line-height: 1.3; flex: 1; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; letter-spacing: 1px; white-space: nowrap; }
    .badge-open { background: rgba(93,174,114,0.15); color: var(--success); }
    .badge-closed { background: rgba(232,93,93,0.15); color: var(--danger); }
    .badge-24h { background: var(--border); color: var(--text-primary); }
    .meta { font-size: 13px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 6px; }
    .meta-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .dot-rating { width: 7px; height: 7px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
    .dot-green { background: var(--success); box-shadow: 0 0 6px var(--success); }
    .dot-amber { background: var(--amber); box-shadow: 0 0 6px var(--amber); }
    .dot-red { background: var(--danger); box-shadow: 0 0 6px var(--danger); }
    .dist { color: var(--accent); font-weight: 500; font-family: monospace; font-size: 12px; }
    .dist.behind { color: var(--amber); }
    .actions { display: flex; gap: 10px; }
    .btn {
      flex: 1; padding: 14px; border-radius: 10px; text-align: center; text-decoration: none;
      font-size: 14px; font-weight: 500; transition: all 0.2s; display: block; border: none; cursor: pointer; font-family: inherit;
    }
    .btn-primary { background: var(--text-primary); color: var(--bg); }
    .btn-primary:hover { background: #fff; transform: translateY(-2px); }
    .btn-secondary { background: transparent; color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--text-muted); background: rgba(255,255,255,0.05); transform: translateY(-2px); }

    /* Recently Passed Section */
    .passed-banner {
      display: flex; align-items: center; gap: 10px; padding: 14px 18px; margin-bottom: 20px;
      background: rgba(212,165,74,0.08); border: 1px solid rgba(212,165,74,0.2); border-radius: 10px;
      font-size: 13px; color: var(--amber); font-weight: 500;
    }
    .empty-state { font-size: 14px; color: var(--text-muted); padding: 20px 0; }

    /* Quick Actions */
    .qa-btn {
      display: flex; align-items: center; gap: 14px; padding: 24px; margin-bottom: 12px;
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      color: var(--text-primary); text-decoration: none; font-size: 17px; font-weight: 500;
      transition: all 0.3s; cursor: pointer;
    }
    .qa-btn span.icon { font-size: 22px; }
    .qa-btn:hover { background: var(--surface-hover); transform: translateY(-2px); }
    .qa-btn.danger { border-color: rgba(232,93,93,0.3); color: var(--danger); }
    .qa-btn.danger:hover { background: rgba(232,93,93,0.08); border-color: var(--danger); }

    /* Footer */
    footer { padding: 60px 20px 80px; border-top: 1px solid var(--border); max-width: 680px; margin: 0 auto; }
    footer .logo { color: var(--text-primary); text-transform: uppercase; letter-spacing: 2px; font-size: 12px; font-weight: 600; margin-bottom: 12px; }
    footer .sub { font-size: 14px; margin-bottom: 12px; color: var(--text-secondary); }
    footer .disclaimer { font-size: 11px; color: var(--text-muted); line-height: 1.5; }

    /* Leaflet tooltip override */
    .hospital-tooltip {
      background: rgba(10,10,10,0.9) !important; border: 1px solid var(--border) !important;
      color: var(--text-primary) !important; font-family: 'Inter', sans-serif !important;
      font-size: 12px !important; padding: 6px 10px !important; border-radius: 6px !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
    }
    .hospital-tooltip::before { border-top-color: rgba(10,10,10,0.9) !important; }

    @media (min-width: 600px) {
      .dash-cards { grid-template-columns: repeat(4, 1fr); }
      .dash-card.wide { grid-column: auto; }
      .nav-route { display: block; }
      #hero { height: 60vh; }
    }
  </style>
</head>
<body>

  <!-- NAV (hidden on entry, shown on tracking) -->
  <nav id="navbar" style="display:none">
    <div class="nav-logo">Mason's MedWay</div>
    <div class="nav-route" id="nav-route"></div>
    <div class="nav-right">
      <button class="btn-change-route" id="btn-change-route" onclick="showEntryScreen()">Change Route</button>
      <div class="gps-dot" id="gps-dot"></div>
    </div>
  </nav>

  <!-- ENTRY SCREEN -->
  <div id="entry-screen">
    <div class="entry-logo">Mason's MedWay</div>
    <h1 class="entry-title">Enter your route</h1>
    <p class="entry-sub">Find every hospital within 15 minutes of the highway along any route in the US.</p>
    <form class="entry-form" id="route-form" onsubmit="startRoute(event)">
      <div class="input-group">
        <label>Start</label>
        <input type="text" id="input-start" placeholder="Starting address or city" required autocomplete="off">
        <button type="button" class="btn-locate" onclick="useMyLocation()">Use my location</button>
      </div>
      <div class="input-group">
        <label>Destination</label>
        <input type="text" id="input-end" placeholder="Destination address or city" required autocomplete="off">
      </div>
      <button type="submit" class="btn-find" id="btn-find">Find Hospitals</button>
      <div class="entry-error" id="entry-error"></div>
    </form>
  </div>

  <!-- LOADING OVERLAY -->
  <div id="loading-overlay">
    <div class="loading-text" id="loading-text">Calculating route...</div>
    <div class="loading-bar"><div class="loading-bar-fill" id="loading-bar-fill"></div></div>
    <div class="loading-sub" id="loading-sub"></div>
  </div>

  <!-- ROUTE SELECTION -->
  <div id="route-select">
    <button class="route-select-back" onclick="showEntryScreen()">Back</button>
    <div id="route-select-map"></div>
    <div class="route-select-panel">
      <div class="route-select-label">Choose a route</div>
      <div class="route-options" id="route-options"></div>
      <button class="btn-use-route" id="btn-use-route" onclick="confirmRoute()">Use this route</button>
    </div>
  </div>

  <!-- TRACKING VIEW -->
  <div id="tracking-view">
    <div id="hero">
      <div id="map"></div>
      <div class="hero-overlay" id="hero-overlay">
        <div class="hero-label">Live Route Tracker</div>
        <h1 class="hero-title">Mason's MedWay</h1>
        <div class="hero-sub" id="hero-route-label"></div>
      </div>
      <div class="scroll-indicator"></div>
    </div>

    <section id="s001">
      <span class="sec-num animate-in">001 ¬∑ STATUS</span>
      <h2 class="animate-in">Know what's ahead.</h2>
      <p class="sec-desc animate-in">Real-time tracking along your route.</p>
      <div id="gps-banner">Enable location services to track your position. Showing all facilities along the route.</div>
      <div class="dash-cards animate-in" id="dash-visible">
        <div class="dash-card wide"><label>Current Location</label><div class="val" id="val-loc">Detecting...</div></div>
        <div class="dash-card"><label>Next Hospital</label><div class="val" id="val-next">‚Äî</div></div>
        <div class="dash-card"><label>Ahead</label><div class="val" id="val-ahead">0</div></div>
        <div class="dash-card"><label>Passed</label><div class="val amber" id="val-passed">0</div></div>
      </div>
    </section>

    <section id="s002">
      <span class="sec-num animate-in">002 ¬∑ UPCOMING HOSPITALS</span>
      <h2 class="animate-in">Hospitals ahead.</h2>
      <p class="sec-desc animate-in">Facilities ahead of you, within 15 minutes of the highway.</p>
      <div class="hospital-list" id="upcoming-list"></div>
    </section>

    <section id="s003">
      <span class="sec-num animate-in" style="color: var(--amber)">003 ¬∑ RECENTLY PASSED</span>
      <h2 class="animate-in">Recently passed.</h2>
      <p class="sec-desc animate-in">You've passed these, but they're still within 15 minutes behind you.</p>
      <div class="hospital-list" id="passed-list"></div>
    </section>

    <section id="s004">
      <span class="sec-num animate-in">004 ¬∑ EMERGENCY</span>
      <h2 class="animate-in">In an emergency.</h2>
      <p class="sec-desc animate-in">Immediate actions based on your current location.</p>
      <div class="animate-in">
        <a href="tel:911" class="qa-btn danger"><span class="icon">üö®</span> Call 911</a>
        <a id="nearest-hospital-link" href="https://www.google.com/maps/search/hospitals+near+me" target="_blank" class="qa-btn"><span class="icon">üìç</span> Nearest Hospital Now</a>
        <a href="#hero" class="qa-btn"><span class="icon">üìã</span> Back to Map</a>
      </div>
    </section>

    <footer>
      <div class="logo animate-in">Mason's MedWay</div>
      <div class="sub animate-in" id="footer-info">Dynamic Route Hospital Finder</div>
      <div class="disclaimer animate-in">
        Hospital data from Google Places. Ratings from Google Reviews. In an emergency, always call 911.<br><br>
        &copy; 2025 Mason's MedWay. All rights reserved.
      </div>
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

  <script>
    // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
    let API_KEY = localStorage.getItem('mm_api_key') || '';
    let map, routeLine, userMarker;
    let routePoints = [];
    let routeSegments = [];
    let totalRouteDist = 0;
    let hospitals = [];
    let hospitalMarkers = [];
    let userLat = null, userLng = null;
    let userProgress = null;
    let gpsDenied = false;
    let gpsWatchId = null;
    let mapInteracting = false;
    let mapInteractTimer = null;
    let lastReverseGeocode = 0;
    let googleLoaded = false;
    let placesService = null;

    // Route selection state
    let selectMap = null;
    let allRoutes = [];
    let selectedRouteIndex = 0;
    let selectPolylines = [];
    let startName = '', endName = '';

    // ‚îÄ‚îÄ‚îÄ API KEY MANAGEMENT ‚îÄ‚îÄ‚îÄ
    function promptApiKey(e) {
      if (e) e.preventDefault();
      const key = prompt('Enter your Google Maps API key:', API_KEY);
      if (key && key.trim()) {
        API_KEY = key.trim();
        localStorage.setItem('mm_api_key', API_KEY);
        loadGoogleMaps();
      }
    }

    let _gmPromise = null;
    function loadGoogleMaps() {
      if (googleLoaded || !API_KEY) return Promise.resolve();
      if (_gmPromise) return _gmPromise;
      _gmPromise = new Promise((resolve, reject) => {
        window._gmResolve = () => { googleLoaded = true; resolve(); };
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places&callback=_gmResolve`;
        s.async = true; s.defer = true;
        s.onerror = () => { _gmPromise = null; reject(new Error('Failed to load Google Maps')); };
        document.head.appendChild(s);
      });
      return _gmPromise;
    }

    // ‚îÄ‚îÄ‚îÄ HAVERSINE ‚îÄ‚îÄ‚îÄ
    function haversine(lat1, lng1, lat2, lng2) {
      const R = 3958.8;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // ‚îÄ‚îÄ‚îÄ ROUTE PROGRESS ‚îÄ‚îÄ‚îÄ
    function buildRouteSegments() {
      routeSegments = [];
      totalRouteDist = 0;
      for (let i = 0; i < routePoints.length - 1; i++) {
        const p1 = routePoints[i], p2 = routePoints[i+1];
        const d = haversine(p1.lat, p1.lng, p2.lat, p2.lng);
        routeSegments.push({ p1, p2, dist: d, cum: totalRouteDist });
        totalRouteDist += d;
      }
    }

    function projectOnSegment(p, a, b) {
      const ab = { lat: b.lat - a.lat, lng: b.lng - a.lng };
      const ap = { lat: p.lat - a.lat, lng: p.lng - a.lng };
      const len2 = ab.lat*ab.lat + ab.lng*ab.lng;
      if (len2 === 0) return 0;
      return Math.max(0, Math.min(1, (ap.lat*ab.lat + ap.lng*ab.lng) / len2));
    }

    function getRouteProgress(lat, lng) {
      let minD = Infinity, bestMile = 0;
      const p = { lat, lng };
      for (const s of routeSegments) {
        const t = projectOnSegment(p, s.p1, s.p2);
        const projLat = s.p1.lat + t * (s.p2.lat - s.p1.lat);
        const projLng = s.p1.lng + t * (s.p2.lng - s.p1.lng);
        const d = haversine(lat, lng, projLat, projLng);
        if (d < minD) {
          minD = d;
          const segProgress = haversine(s.p1.lat, s.p1.lng, projLat, projLng);
          bestMile = s.cum + segProgress;
        }
      }
      return { miles: bestMile, distFromRoute: minD };
    }

    // ‚îÄ‚îÄ‚îÄ LEAFLET MAP SETUP ‚îÄ‚îÄ‚îÄ
    function initMap() {
      map = L.map('map', { zoomControl: false, scrollWheelZoom: true }).setView([39.5, -84.5], 5);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19, attribution: '&copy; CartoDB'
      }).addTo(map);

      map.on('mousedown touchstart', () => {
        mapInteracting = true;
        clearTimeout(mapInteractTimer);
      });
      map.on('mouseup touchend', () => {
        clearTimeout(mapInteractTimer);
        mapInteractTimer = setTimeout(() => { mapInteracting = false; }, 10000);
      });
    }

    let routeGlow = null;
    function drawRoute(points) {
      if (routeGlow) map.removeLayer(routeGlow);
      if (routeLine) map.removeLayer(routeLine);
      const coords = points.map(p => [p.lat, p.lng]);
      // Glow layer (wider, lower opacity)
      routeGlow = L.polyline(coords, { color: '#C8D96F', weight: 12, opacity: 0.15 }).addTo(map);
      // Main route line
      routeLine = L.polyline(coords, { color: '#C8D96F', weight: 4, opacity: 0.7 }).addTo(map);
      map.fitBounds(routeLine.getBounds(), { padding: [60, 60], maxZoom: 12 });
    }

    function createMarkerIcon(color, size, isUser) {
      if (isUser) {
        return L.divIcon({
          className: 'custom-icon',
          html: `<div style="background:${color};width:${size}px;height:${size}px;border-radius:50%;box-shadow:0 0 12px ${color};border:2px solid #fff;"></div>`,
          iconSize: [size, size], iconAnchor: [size/2, size/2]
        });
      }
      const diameter = size * 2;
      return L.divIcon({
        className: 'custom-icon',
        html: `<div style="background:${color};width:${diameter}px;height:${diameter}px;border-radius:50%;box-shadow:0 0 6px ${color}50;border:1.5px solid rgba(255,255,255,0.2);"></div>`,
        iconSize: [diameter, diameter], iconAnchor: [diameter/2, diameter/2]
      });
    }

    // ‚îÄ‚îÄ‚îÄ ENTRY SCREEN ‚îÄ‚îÄ‚îÄ
    function showEntryScreen() {
      if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
      document.getElementById('entry-screen').style.display = 'flex';
      document.getElementById('tracking-view').style.display = 'none';
      document.getElementById('loading-overlay').style.display = 'none';
      document.getElementById('route-select').style.display = 'none';
      document.getElementById('navbar').style.display = 'none';
      // Clean up all map layers and state
      hospitalMarkers.forEach(m => map && map.removeLayer(m));
      hospitalMarkers = [];
      hospitals = [];
      if (routeLine && map) { map.removeLayer(routeLine); routeLine = null; }
      if (routeGlow && map) { map.removeLayer(routeGlow); routeGlow = null; }
      if (userMarker && map) { map.removeLayer(userMarker); userMarker = null; }
      selectPolylines.forEach(p => selectMap && selectMap.removeLayer(p));
      selectPolylines = [];
      allRoutes = [];
      routePoints = [];
      routeSegments = [];
      totalRouteDist = 0;
      userProgress = null;
      gpsDenied = false;
    }

    function useMyLocation() {
      const btn = document.querySelector('.btn-locate');
      btn.textContent = 'Locating...';
      navigator.geolocation.getCurrentPosition(pos => {
        document.getElementById('input-start').value = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
        btn.textContent = 'Located!';
        setTimeout(() => { btn.textContent = 'Use my location'; }, 2000);
      }, () => {
        btn.textContent = 'GPS denied';
        setTimeout(() => { btn.textContent = 'Use my location'; }, 2000);
      }, { enableHighAccuracy: true });
    }

    // ‚îÄ‚îÄ‚îÄ START ROUTE (Phase 1: get directions, show route picker) ‚îÄ‚îÄ‚îÄ
    async function startRoute(e) {
      e.preventDefault();
      const startAddr = document.getElementById('input-start').value.trim();
      const endAddr = document.getElementById('input-end').value.trim();
      if (!startAddr || !endAddr) return;

      if (!API_KEY) { promptApiKey(); if (!API_KEY) return; }

      const errEl = document.getElementById('entry-error');
      errEl.style.display = 'none';

      document.getElementById('btn-find').disabled = true;
      document.getElementById('btn-find').textContent = 'Loading...';

      try {
        if (!googleLoaded) await loadGoogleMaps();

        // Show loading
        document.getElementById('entry-screen').style.display = 'none';
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'flex';
        setLoading('Calculating routes...', 10, '');

        // Get directions with alternatives
        const directionsService = new google.maps.DirectionsService();
        const result = await new Promise((resolve, reject) => {
          directionsService.route({
            origin: startAddr,
            destination: endAddr,
            travelMode: 'DRIVING',
            provideRouteAlternatives: true
          }, (res, status) => {
            if (status === 'OK') resolve(res);
            else reject(new Error('Could not find route: ' + status));
          });
        });

        // Parse all routes
        allRoutes = result.routes.map((route, i) => {
          const legs = route.legs;
          const totalDist = legs.reduce((sum, l) => sum + l.distance.value, 0);
          const totalDur = legs.reduce((sum, l) => sum + l.duration.value, 0);
          const points = route.overview_path.map(p => ({ lat: p.lat(), lng: p.lng() }));
          // Extract "via" hint from summary
          const via = route.summary || '';
          return { points, totalDist, totalDur, via, legs };
        });

        // Get readable start/end names from first route
        const legs0 = allRoutes[0].legs;
        startName = legs0[0].start_address.split(',').slice(0,2).join(',');
        endName = legs0[legs0.length-1].end_address.split(',').slice(0,2).join(',');

        selectedRouteIndex = 0;
        overlay.style.display = 'none';

        // If only one route, skip selection and go straight to tracking
        if (allRoutes.length === 1) {
          await beginTracking();
        } else {
          showRouteSelection();
        }

      } catch (err) {
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('entry-screen').style.display = 'flex';
        errEl.textContent = err.message || 'Something went wrong. Check your API key.';
        errEl.style.display = 'block';
      } finally {
        document.getElementById('btn-find').disabled = false;
        document.getElementById('btn-find').textContent = 'Find Hospitals';
      }
    }

    // ‚îÄ‚îÄ‚îÄ ROUTE SELECTION ‚îÄ‚îÄ‚îÄ
    function showRouteSelection() {
      document.getElementById('route-select').style.display = 'block';

      // Init selection map
      if (!selectMap) {
        selectMap = L.map('route-select-map', { zoomControl: false }).setView([39.5, -84.5], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          maxZoom: 19, attribution: '&copy; CartoDB'
        }).addTo(selectMap);
      }
      setTimeout(() => selectMap.invalidateSize(), 100);

      // Draw all routes and build option cards
      drawSelectionRoutes();
      buildRouteOptionCards();
    }

    function drawSelectionRoutes() {
      // Clear previous
      selectPolylines.forEach(p => selectMap.removeLayer(p));
      selectPolylines = [];

      // Draw unselected routes first (behind), then selected on top
      allRoutes.forEach((route, i) => {
        if (i === selectedRouteIndex) return;
        const coords = route.points.map(p => [p.lat, p.lng]);
        const poly = L.polyline(coords, {
          color: '#4A4A45', weight: 4, opacity: 0.5, className: 'route-alt'
        }).addTo(selectMap);
        poly.on('click', () => selectRoute(i));
        selectPolylines.push(poly);
      });

      // Selected route on top
      const selected = allRoutes[selectedRouteIndex];
      const coords = selected.points.map(p => [p.lat, p.lng]);
      const glow = L.polyline(coords, { color: '#C8D96F', weight: 12, opacity: 0.15 }).addTo(selectMap);
      const main = L.polyline(coords, { color: '#C8D96F', weight: 5, opacity: 0.8 }).addTo(selectMap);
      selectPolylines.push(glow, main);

      // Fit bounds to show all routes
      const allCoords = allRoutes.flatMap(r => r.points.map(p => [p.lat, p.lng]));
      if (allCoords.length > 0) {
        selectMap.fitBounds(allCoords, { padding: [40, 40], maxZoom: 12 });
      }
    }

    function buildRouteOptionCards() {
      const container = document.getElementById('route-options');
      container.innerHTML = '';

      allRoutes.forEach((route, i) => {
        const hrs = Math.floor(route.totalDur / 3600);
        const mins = Math.round((route.totalDur % 3600) / 60);
        const durText = hrs > 0 ? `${hrs} hr ${mins} min` : `${mins} min`;
        const distMi = (route.totalDist / 1609.34).toFixed(0);

        const btn = document.createElement('button');
        btn.className = 'route-option' + (i === selectedRouteIndex ? ' selected' : '');
        btn.innerHTML = `
          <div class="ro-index">${String.fromCharCode(65 + i)}</div>
          <div class="ro-details">
            <div class="ro-duration">${durText}</div>
            <div class="ro-meta">${distMi} miles</div>
            ${route.via ? `<div class="ro-via">via ${route.via}</div>` : ''}
          </div>
        `;
        btn.onclick = () => selectRoute(i);
        container.appendChild(btn);
      });
    }

    function selectRoute(index) {
      selectedRouteIndex = index;
      drawSelectionRoutes();
      buildRouteOptionCards();
    }

    async function confirmRoute() {
      document.getElementById('route-select').style.display = 'none';

      const overlay = document.getElementById('loading-overlay');
      overlay.style.display = 'flex';
      setLoading('Finding hospitals along your route...', 40, '');

      await beginTracking();
    }

    // ‚îÄ‚îÄ‚îÄ BEGIN TRACKING (Phase 2: use selected route, find hospitals) ‚îÄ‚îÄ‚îÄ
    async function beginTracking() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay.style.display !== 'flex') {
        overlay.style.display = 'flex';
        setLoading('Finding hospitals along your route...', 40, '');
      }

      try {
        const selected = allRoutes[selectedRouteIndex];
        routePoints = selected.points;
        buildRouteSegments();

        // Show tracking view
        document.getElementById('tracking-view').style.display = 'block';
        document.getElementById('navbar').style.display = 'flex';
        document.getElementById('btn-change-route').style.display = 'block';
        document.getElementById('nav-route').textContent = `${startName} ‚Üí ${endName}`;
        document.getElementById('hero-route-label').textContent = `${startName} ‚Üí ${endName}`;

        // Init main map after container is visible
        if (!map) {
          initMap();
        } else {
          map.invalidateSize();
        }
        setTimeout(() => { map.invalidateSize(); drawRoute(routePoints); }, 150);

        // Find hospitals
        await findHospitalsAlongRoute();

        // Done loading
        overlay.style.display = 'none';
        document.getElementById('footer-info').textContent = `${hospitals.length} hospitals ¬∑ ${Math.round(totalRouteDist)} mi route`;

        // Start GPS tracking
        startGpsTracking();
        initAnimations();
        updateView();

      } catch (err) {
        overlay.style.display = 'none';
        document.getElementById('entry-screen').style.display = 'flex';
        const errEl = document.getElementById('entry-error');
        errEl.textContent = err.message || 'Something went wrong.';
        errEl.style.display = 'block';
      }
    }

    function setLoading(text, pct, sub) {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading-bar-fill').style.width = pct + '%';
      document.getElementById('loading-sub').textContent = sub;
    }

    // ‚îÄ‚îÄ‚îÄ HOSPITAL DISCOVERY ‚îÄ‚îÄ‚îÄ
    async function findHospitalsAlongRoute() {
      // Sample points along route
      const sampleInterval = totalRouteDist < 20 ? 5 : (totalRouteDist > 1000 ? 30 : 20);
      const samplePoints = [];
      let accum = 0;
      samplePoints.push(routePoints[0]);
      for (let i = 1; i < routePoints.length; i++) {
        const d = haversine(routePoints[i-1].lat, routePoints[i-1].lng, routePoints[i].lat, routePoints[i].lng);
        accum += d;
        if (accum >= sampleInterval) {
          samplePoints.push(routePoints[i]);
          accum = 0;
        }
      }
      if (samplePoints.length < 2) samplePoints.push(routePoints[routePoints.length - 1]);

      // Create a persistent hidden map div for PlacesService (reused across detail loads)
      if (!placesService) {
        const tempDiv = document.createElement('div');
        tempDiv.id = 'places-service-div';
        tempDiv.style.cssText = 'width:1px;height:1px;position:absolute;left:-9999px;';
        document.body.appendChild(tempDiv);
        const tempMap = new google.maps.Map(tempDiv);
        placesService = new google.maps.places.PlacesService(tempMap);
      }

      const seen = new Set();
      let searched = 0;

      for (const pt of samplePoints) {
        searched++;
        setLoading(
          'Finding hospitals along your route...',
          40 + Math.round((searched / samplePoints.length) * 50),
          `Searched ${searched} of ${samplePoints.length} points ¬∑ ${hospitals.length} hospitals found`
        );

        try {
          const results = await nearbySearch(pt.lat, pt.lng);
          for (const place of results) {
            if (seen.has(place.place_id)) continue;
            seen.add(place.place_id);

            const h = {
              name: place.name,
              place_id: place.place_id,
              lat: place.geometry.location.lat(),
              lng: place.geometry.location.lng(),
              rating: place.rating || 0,
              rating_count: place.user_ratings_total || 0,
              address: place.vicinity || '',
              open_now: place.opening_hours?.open_now ?? null,
              phone: null,
              website: null,
            };

            // Calculate route progress and distance from route
            const prog = getRouteProgress(h.lat, h.lng);
            h.routeMile = prog.miles;
            h.distFromRoute = prog.distFromRoute;

            // Only keep hospitals within ~15 miles of the route corridor
            if (h.distFromRoute <= 15) {
              hospitals.push(h);

              // Add marker to map immediately
              const marker = L.marker([h.lat, h.lng], {
                icon: createMarkerIcon('#5DAE72', 6)
              }).addTo(map);
              marker.bindTooltip(h.name, { direction: 'top', className: 'hospital-tooltip' });
              h.marker = marker;
              hospitalMarkers.push(marker);
            }
          }
        } catch (err) {
          console.warn('Places search failed for point:', pt, err);
        }

        // Rate limit: 200ms between requests
        await new Promise(r => setTimeout(r, 200));
      }

      // Sort hospitals by route mile
      hospitals.sort((a, b) => a.routeMile - b.routeMile);

      // Lazy load details for first 30
      loadHospitalDetails(hospitals.slice(0, 30));
    }

    function nearbySearch(lat, lng) {
      return new Promise((resolve, reject) => {
        placesService.nearbySearch({
          location: { lat, lng },
          radius: 24140, // 15 miles in meters
          type: 'hospital'
        }, (results, status) => {
          if (status === 'OK' || status === 'ZERO_RESULTS') resolve(results || []);
          else reject(new Error(status));
        });
      });
    }

    async function loadHospitalDetails(subset) {
      for (const h of subset) {
        if (h.phone !== null) continue; // already loaded
        try {
          const details = await getPlaceDetails(h.place_id);
          h.phone = details.formatted_phone_number || null;
          h.open_now = details.opening_hours?.isOpen?.() ?? h.open_now;
          h.website = details.website || null;
          h.address = details.formatted_address || h.address;
          // Extract city/state from address
          const parts = (h.address || '').split(',').map(s => s.trim());
          if (parts.length >= 2) {
            h.city = parts[parts.length - 3] || parts[0];
            h.stateZip = parts[parts.length - 2] || '';
          }
        } catch (err) {
          console.warn('Details failed for', h.name, err);
        }
        await new Promise(r => setTimeout(r, 100));
      }
      updateView();
    }

    function getPlaceDetails(placeId) {
      return new Promise((resolve, reject) => {
        placesService.getDetails({
          placeId,
          fields: ['formatted_phone_number', 'opening_hours', 'website', 'formatted_address']
        }, (place, status) => {
          if (status === 'OK') resolve(place);
          else reject(new Error(status));
        });
      });
    }

    // ‚îÄ‚îÄ‚îÄ GPS TRACKING ‚îÄ‚îÄ‚îÄ
    function startGpsTracking() {
      if (gpsWatchId) return;
      gpsWatchId = navigator.geolocation.watchPosition(pos => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;

        const gpsDot = document.getElementById('gps-dot');
        gpsDot.classList.add('active');
        gpsDenied = false;

        // Update user marker on map
        if (!userMarker) {
          userMarker = L.marker([userLat, userLng], {
            icon: createMarkerIcon('#5DAE72', 14, true),
            zIndexOffset: 1000
          }).addTo(map);
        } else {
          userMarker.setLatLng([userLat, userLng]);
        }

        // Auto-pan unless user is interacting
        if (!mapInteracting) {
          map.panTo([userLat, userLng], { animate: true });
        }

        // Calculate route progress
        const prog = getRouteProgress(userLat, userLng);
        userProgress = prog.miles;

        // Reverse geocode periodically
        const now = Date.now();
        if (now - lastReverseGeocode > 30000) {
          lastReverseGeocode = now;
          reverseGeocode(userLat, userLng);
        }

        updateView();

      }, err => {
        console.warn('GPS error:', err);
        gpsDenied = true;
        document.getElementById('gps-dot').classList.remove('active');
        updateView();
      }, { enableHighAccuracy: true, maximumAge: 10000 });
    }

    function reverseGeocode(lat, lng) {
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(r => r.json())
        .then(data => {
          if (data?.address) {
            const city = data.address.city || data.address.town || data.address.village || '';
            const state = data.address.state || '';
            if (city || state) {
              document.getElementById('val-loc').textContent = [city, state].filter(Boolean).join(', ');
            }
          }
        })
        .catch(() => {});
    }

    // ‚îÄ‚îÄ‚îÄ UPDATE VIEW ‚îÄ‚îÄ‚îÄ
    function updateView() {
      const upcoming = [];
      const passed = [];

      if (gpsDenied || userProgress === null) {
        // Show all as upcoming
        document.getElementById('gps-banner').style.display = 'block';
        document.getElementById('dash-visible').style.display = 'none';
        renderHospitalList('upcoming-list', hospitals, false);
        renderHospitalList('passed-list', [], true);
        return;
      }

      document.getElementById('gps-banner').style.display = 'none';
      document.getElementById('dash-visible').style.display = 'grid';

      for (const h of hospitals) {
        const diff = h.routeMile - userProgress;
        h._diff = diff;

        if (diff > 0) {
          // Upcoming
          h._label = `${Math.round(diff)} mi ahead`;
          if (h.distFromRoute > 0.5) h._label += ` ¬∑ ${Math.round(h.distFromRoute)} mi off hwy`;
          upcoming.push(h);

          // Green marker
          if (h.marker) h.marker.setIcon(createMarkerIcon('#5DAE72', 6));
          if (h.marker) h.marker.setOpacity(1);

        } else if (Math.abs(diff) <= 15) {
          // Recently passed
          h._label = `${Math.round(Math.abs(diff))} mi behind`;
          passed.push(h);

          // Amber marker
          if (h.marker) h.marker.setIcon(createMarkerIcon('#D4A54A', 5));
          if (h.marker) h.marker.setOpacity(0.7);

        } else {
          // Out of range ‚Äî fade marker
          if (h.marker) h.marker.setOpacity(0.1);
        }
      }

      upcoming.sort((a, b) => a._diff - b._diff);
      passed.sort((a, b) => b._diff - a._diff); // most recent first

      // Dashboard
      document.getElementById('val-ahead').textContent = upcoming.length;
      document.getElementById('val-passed').textContent = passed.length;
      if (upcoming.length > 0) {
        document.getElementById('val-next').textContent = upcoming[0].name;
      } else {
        document.getElementById('val-next').textContent = '‚Äî';
      }

      // Update nearest hospital link
      if (userLat) {
        document.getElementById('nearest-hospital-link').href =
          `https://www.google.com/maps/search/hospitals/@${userLat},${userLng},13z`;
      }

      renderHospitalList('upcoming-list', upcoming, false);
      renderHospitalList('passed-list', passed, true);
    }

    function renderHospitalList(containerId, list, isPassed) {
      const container = document.getElementById(containerId);

      if (list.length === 0) {
        container.innerHTML = `<div class="empty-state">${isPassed ? 'No recently passed hospitals' : 'No upcoming hospitals'}</div>`;
        return;
      }

      // Build a fingerprint to avoid unnecessary re-renders
      const fp = list.map(h => h.place_id + (h._label || '')).join('|');
      if (container._fp === fp) return;
      container._fp = fp;

      container.innerHTML = '';

      if (isPassed && list.length > 0) {
        const banner = document.createElement('div');
        banner.className = 'passed-banner';
        banner.textContent = "You've passed these, but they're still reachable";
        container.appendChild(banner);
      }

      list.forEach(h => {
        const rClass = h.rating >= 4.0 ? 'dot-green' : (h.rating >= 3.0 ? 'dot-amber' : 'dot-red');
        const distClass = isPassed ? 'dist behind' : 'dist';

        let badgeHTML = '';
        if (h.open_now === true) badgeHTML = '<span class="badge badge-open">OPEN</span>';
        else if (h.open_now === false) badgeHTML = '<span class="badge badge-closed">CLOSED</span>';
        else badgeHTML = '<span class="badge badge-24h">24H</span>';

        const cityState = h.city && h.stateZip ? `${h.city}, ${h.stateZip}` : (h.address || '');
        const phoneBtn = h.phone
          ? `<a href="tel:${h.phone}" class="btn btn-secondary">Call</a>`
          : `<a class="btn btn-secondary" style="opacity:0.4;pointer-events:none">Call</a>`;

        const card = document.createElement('div');
        card.className = 'h-card' + (isPassed ? ' passed' : '');
        card.innerHTML = `
          <div class="h-header">
            <h3 class="h-title">${h.name}</h3>
            ${badgeHTML}
          </div>
          <div class="meta">
            <div class="${distClass}">${h._label || ''}</div>
            <div class="meta-row">
              <span class="dot-rating ${rClass}"></span>
              <span>${h.rating > 0 ? h.rating + ' ‚òÖ' : 'No rating'} ${h.rating_count ? '(' + h.rating_count + ')' : ''}</span>
              <span style="color:var(--text-muted)">¬∑</span>
              <span>${cityState}</span>
            </div>
          </div>
          <div class="actions">
            <a href="https://www.google.com/maps/dir/?api=1&destination=${h.lat},${h.lng}&travelmode=driving" target="_blank" class="btn btn-primary">Directions</a>
            ${phoneBtn}
          </div>
        `;
        container.appendChild(card);
      });

      // Animate new cards
      gsap.from(container.querySelectorAll('.h-card'), {
        y: 30, opacity: 0, duration: 0.5, stagger: 0.08, ease: 'power2.out'
      });
    }

    // ‚îÄ‚îÄ‚îÄ GSAP ‚îÄ‚îÄ‚îÄ
    gsap.registerPlugin(ScrollTrigger);

    function initAnimations() {
      gsap.utils.toArray('.animate-in').forEach(el => {
        gsap.from(el, {
          y: 30, opacity: 0, duration: 0.7, ease: 'power2.out',
          scrollTrigger: { trigger: el, start: 'top 88%', toggleActions: 'play none none none' }
        });
      });
    }

    window.addEventListener('scroll', () => {
      const nav = document.getElementById('navbar');
      if (nav.style.display !== 'none') {
        nav.classList.toggle('scrolled', window.scrollY > 50);
      }
    });

    // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
    // Entry animations
    gsap.from('.entry-logo', { y: 20, opacity: 0, duration: 0.6, ease: 'power2.out', delay: 0.1 });
    gsap.from('.entry-title', { y: 30, opacity: 0, duration: 0.7, ease: 'power2.out', delay: 0.2 });
    gsap.from('.entry-sub', { y: 20, opacity: 0, duration: 0.6, ease: 'power2.out', delay: 0.35 });
    gsap.from('.entry-form', { y: 30, opacity: 0, duration: 0.7, ease: 'power2.out', delay: 0.45 });
    // Auto-fetch API key from serverless function, fall back to localStorage
    (async function initApiKey() {
      try {
        const res = await fetch('/api/config');
        if (res.ok) {
          const data = await res.json();
          if (data.key) {
            API_KEY = data.key;
            loadGoogleMaps().catch(() => {});
            return;
          }
        }
      } catch (e) {
        // Serverless function unavailable (local dev) ‚Äî fall back to localStorage
      }
      if (API_KEY) loadGoogleMaps().catch(() => {});
    })();

    // Map is initialized lazily in startRoute() when tracking view is first shown
  </script>
</body>
</html>
